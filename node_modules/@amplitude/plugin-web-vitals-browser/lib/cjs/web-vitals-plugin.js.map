{"version":3,"file":"web-vitals-plugin.js","sourceRoot":"","sources":["../../src/web-vitals-plugin.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable no-restricted-globals */\nimport {\n  BrowserClient,\n  BrowserConfig,\n  EnrichmentPlugin,\n  getGlobalScope,\n  getDecodeURI,\n} from '@amplitude/analytics-core';\nimport { PLUGIN_NAME, WEB_VITALS_EVENT_NAME } from './constants';\nimport { onLCP, onINP, onCLS, onFCP, onTTFB, Metric } from 'web-vitals';\n\nexport type BrowserEnrichmentPlugin = EnrichmentPlugin<BrowserClient, BrowserConfig>;\n\ntype WebVitalsMetricPayload = {\n  value: number;\n  rating: Metric['rating'];\n  delta: number;\n  navigationType: Metric['navigationType'];\n  id: string;\n  timestamp: number;\n  navigationStart: number;\n};\n\ntype WebVitalsEventPayload = {\n  '[Amplitude] LCP'?: WebVitalsMetricPayload;\n  '[Amplitude] FCP'?: WebVitalsMetricPayload;\n  '[Amplitude] INP'?: WebVitalsMetricPayload;\n  '[Amplitude] CLS'?: WebVitalsMetricPayload;\n  '[Amplitude] TTFB'?: WebVitalsMetricPayload;\n  '[Amplitude] Page Domain'?: string;\n  '[Amplitude] Page Location'?: string;\n  '[Amplitude] Page Path'?: string;\n  '[Amplitude] Page Title'?: string;\n  '[Amplitude] Page URL'?: string;\n};\n\nfunction getMetricStartTime(metric: Metric) {\n  /* istanbul ignore next */\n  const startTime = metric.entries[0]?.startTime || 0;\n  return performance.timeOrigin + startTime;\n}\n\nfunction processMetric(metric: Metric) {\n  return {\n    value: metric.value,\n    rating: metric.rating,\n    delta: metric.delta,\n    navigationType: metric.navigationType,\n    id: metric.id,\n    timestamp: Math.floor(getMetricStartTime(metric)),\n    navigationStart: Math.floor(performance.timeOrigin),\n  };\n}\n\nexport const webVitalsPlugin = (): BrowserEnrichmentPlugin => {\n  let visibilityListener: ((this: Document, ev: Event) => void) | null = null;\n  const globalScope = getGlobalScope();\n  const doc = globalScope?.document;\n  const location = globalScope?.location;\n  const setup: BrowserEnrichmentPlugin['setup'] = async (config, amplitude) => {\n    if (doc === undefined) {\n      return;\n    }\n    const locationHref = getDecodeURI(/* istanbul ignore next */ location?.href || '', config.loggerProvider);\n    const webVitalsPayload: WebVitalsEventPayload = {\n      '[Amplitude] Page Domain': /* istanbul ignore next */ location?.hostname || '',\n      '[Amplitude] Page Location': locationHref,\n      '[Amplitude] Page Path': getDecodeURI(/* istanbul ignore next */ location?.pathname || '', config.loggerProvider),\n      '[Amplitude] Page Title': /* istanbul ignore next */ (typeof document !== 'undefined' && document.title) || '',\n      '[Amplitude] Page URL': getDecodeURI(locationHref.split('?')[0], config.loggerProvider),\n    };\n\n    onLCP((metric) => {\n      webVitalsPayload['[Amplitude] LCP'] = processMetric(metric);\n    });\n\n    onFCP((metric) => {\n      webVitalsPayload['[Amplitude] FCP'] = processMetric(metric);\n    });\n\n    onINP((metric) => {\n      webVitalsPayload['[Amplitude] INP'] = processMetric(metric);\n    });\n\n    onCLS((metric) => {\n      webVitalsPayload['[Amplitude] CLS'] = processMetric(metric);\n    });\n\n    onTTFB((metric) => {\n      webVitalsPayload['[Amplitude] TTFB'] = processMetric(metric);\n    });\n\n    visibilityListener = () => {\n      if (doc.visibilityState === 'hidden' && visibilityListener) {\n        amplitude.track(WEB_VITALS_EVENT_NAME, webVitalsPayload);\n        doc.removeEventListener('visibilitychange', visibilityListener);\n        visibilityListener = null;\n      }\n    };\n    doc.addEventListener('visibilitychange', visibilityListener);\n  };\n\n  const execute: BrowserEnrichmentPlugin['execute'] = async (event) => {\n    return event;\n  };\n\n  const teardown = async () => {\n    if (visibilityListener) {\n      /* istanbul ignore next */\n      doc?.removeEventListener('visibilitychange', visibilityListener);\n    }\n  };\n\n  return {\n    name: PLUGIN_NAME,\n    type: 'enrichment',\n    setup,\n    execute,\n    teardown,\n  };\n};\n"]}