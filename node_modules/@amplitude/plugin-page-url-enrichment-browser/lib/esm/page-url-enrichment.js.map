{"version":3,"file":"page-url-enrichment.js","sourceRoot":"","sources":["../../src/page-url-enrichment.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  type BrowserClient,\n  type BrowserConfig,\n  BrowserStorage,\n  type EnrichmentPlugin,\n  type Event,\n  getDecodeURI,\n  getGlobalScope,\n  getPageTitle,\n  type ILogger,\n  PageUrlEnrichmentOptions,\n  replaceSensitiveString,\n  SpecialEventType,\n} from '@amplitude/analytics-core';\n\nexport const CURRENT_PAGE_STORAGE_KEY = 'AMP_CURRENT_PAGE';\nexport const PREVIOUS_PAGE_STORAGE_KEY = 'AMP_PREVIOUS_PAGE';\nexport const URL_INFO_STORAGE_KEY = 'AMP_URL_INFO';\n\nexport type URLInfo = {\n  [CURRENT_PAGE_STORAGE_KEY]?: string;\n  [PREVIOUS_PAGE_STORAGE_KEY]?: string;\n};\n\nenum PreviousPageType {\n  Direct = 'direct', // for no prev page or referrer\n  Internal = 'internal', // for internal domains - exact domain matches or when current and previous page are both internal domains\n  External = 'external', // for different domains\n}\n\nexport const EXCLUDED_DEFAULT_EVENT_TYPES = new Set<string>([\n  SpecialEventType.IDENTIFY,\n  SpecialEventType.GROUP_IDENTIFY,\n  SpecialEventType.REVENUE,\n]);\n\nexport const isPageUrlEnrichmentEnabled = (option: unknown): boolean => {\n  if (typeof option === 'boolean') {\n    return option;\n  }\n  if (typeof option === 'object' && option !== null && 'pageUrlEnrichment' in option) {\n    return Boolean((option as { pageUrlEnrichment?: boolean }).pageUrlEnrichment);\n  }\n  return false;\n};\n\nexport const pageUrlEnrichmentPlugin = ({ internalDomains = [] }: PageUrlEnrichmentOptions = {}): EnrichmentPlugin => {\n  const globalScope = getGlobalScope();\n  let sessionStorage: BrowserStorage<URLInfo> | undefined = undefined;\n  let isStorageEnabled = false;\n  let loggerProvider: ILogger | undefined = undefined;\n\n  let isProxied = false;\n  let isTracking = false;\n\n  const getHostname = (url: string): string | undefined => {\n    let hostname: string | undefined;\n\n    try {\n      const decodedUrl = getDecodeURI(url, loggerProvider);\n      hostname = new URL(decodedUrl).hostname;\n    } catch (e) {\n      /* istanbul ignore next */\n      loggerProvider?.error('Could not parse URL: ', e);\n    }\n\n    return hostname;\n  };\n\n  const getPrevPageType = (previousPage: string) => {\n    const currentDomain = (typeof location !== 'undefined' && location.hostname) || '';\n    const previousPageDomain = previousPage ? getHostname(previousPage) : undefined;\n\n    if (!previousPageDomain) {\n      return PreviousPageType.Direct;\n    }\n\n    const isCurrentInternal = internalDomains.some((domain) => currentDomain.indexOf(domain) !== -1);\n    const isPrevInternal = internalDomains.some((domain) => previousPageDomain.indexOf(domain) !== -1);\n\n    if (currentDomain === previousPageDomain || (isPrevInternal && isCurrentInternal)) {\n      return PreviousPageType.Internal;\n    }\n\n    return PreviousPageType.External;\n  };\n\n  const saveURLInfo = async () => {\n    if (sessionStorage && isStorageEnabled) {\n      const URLInfo = await sessionStorage.get(URL_INFO_STORAGE_KEY);\n      const currentURL = getDecodeURI((typeof location !== 'undefined' && location.href) || '');\n      const storedCurrentURL = URLInfo?.[CURRENT_PAGE_STORAGE_KEY] || '';\n\n      let previousURL: string | undefined;\n      if (currentURL === storedCurrentURL) {\n        previousURL = URLInfo?.[PREVIOUS_PAGE_STORAGE_KEY] || '';\n      } else if (storedCurrentURL) {\n        previousURL = storedCurrentURL;\n      } else {\n        previousURL = document.referrer || '';\n      }\n\n      await sessionStorage.set(URL_INFO_STORAGE_KEY, {\n        [CURRENT_PAGE_STORAGE_KEY]: currentURL,\n        [PREVIOUS_PAGE_STORAGE_KEY]: previousURL,\n      });\n    }\n  };\n\n  const saveUrlInfoWrapper = () => {\n    void saveURLInfo();\n  };\n\n  const plugin: EnrichmentPlugin = {\n    name: '@amplitude/plugin-page-url-enrichment-browser',\n    type: 'enrichment',\n\n    setup: async (config: BrowserConfig, _: BrowserClient) => {\n      loggerProvider = config.loggerProvider;\n      loggerProvider.log('Installing @amplitude/plugin-page-url-enrichment-browser');\n\n      isTracking = true;\n\n      if (globalScope) {\n        sessionStorage = new BrowserStorage<URLInfo>(globalScope.sessionStorage);\n        isStorageEnabled = await sessionStorage.isEnabled();\n\n        globalScope.addEventListener('popstate', saveUrlInfoWrapper);\n\n        if (!isProxied) {\n          /* istanbul ignore next */\n          // There is no global browser listener for changes to history, so we have\n          // to modify pushState and replaceState directly.\n          // https://stackoverflow.com/a/64927639\n          // eslint-disable-next-line @typescript-eslint/unbound-method\n          globalScope.history.pushState = new Proxy(globalScope.history.pushState, {\n            apply: (target, thisArg, [state, unused, url]) => {\n              target.apply(thisArg, [state, unused, url]);\n              if (isTracking) {\n                saveUrlInfoWrapper();\n              }\n            },\n          });\n\n          // eslint-disable-next-line @typescript-eslint/unbound-method\n          globalScope.history.replaceState = new Proxy(globalScope.history.replaceState, {\n            apply: (target, thisArg, [state, unused, url]) => {\n              target.apply(thisArg, [state, unused, url]);\n              if (isTracking) {\n                saveUrlInfoWrapper();\n              }\n            },\n          });\n\n          isProxied = true;\n        }\n      }\n    },\n    execute: async (event: Event) => {\n      const locationHREF = getDecodeURI((typeof location !== 'undefined' && location.href) || '');\n\n      if (sessionStorage && isStorageEnabled) {\n        const URLInfo = await sessionStorage.get(URL_INFO_STORAGE_KEY);\n        if (!URLInfo?.[CURRENT_PAGE_STORAGE_KEY]) {\n          await sessionStorage.set(URL_INFO_STORAGE_KEY, {\n            [CURRENT_PAGE_STORAGE_KEY]: locationHREF,\n            [PREVIOUS_PAGE_STORAGE_KEY]: document.referrer || '',\n          });\n        }\n\n        const updatedURLInfo = await sessionStorage.get(URL_INFO_STORAGE_KEY);\n        let previousPage = '';\n        if (updatedURLInfo) {\n          previousPage = updatedURLInfo[PREVIOUS_PAGE_STORAGE_KEY] || '';\n        }\n\n        // no need to proceed to add additional properties if the event is one of the default event types to be excluded\n        if (EXCLUDED_DEFAULT_EVENT_TYPES.has(event.event_type)) {\n          return event;\n        }\n\n        event.event_properties = {\n          ...(event.event_properties || {}),\n          '[Amplitude] Page Domain': addIfNotExist(\n            event,\n            '[Amplitude] Page Domain',\n            (typeof location !== 'undefined' && location.hostname) || '',\n          ),\n          '[Amplitude] Page Location': addIfNotExist(event, '[Amplitude] Page Location', locationHREF),\n          '[Amplitude] Page Path': addIfNotExist(\n            event,\n            '[Amplitude] Page Path',\n            (typeof location !== 'undefined' && getDecodeURI(location.pathname)) || '',\n          ),\n          '[Amplitude] Page Title': addIfNotExist(\n            event,\n            '[Amplitude] Page Title',\n            getPageTitle(replaceSensitiveString),\n          ),\n          '[Amplitude] Page URL': addIfNotExist(event, '[Amplitude] Page URL', locationHREF.split('?')[0]),\n          '[Amplitude] Previous Page Location': previousPage,\n          '[Amplitude] Previous Page Type': getPrevPageType(previousPage),\n        };\n      }\n\n      return event;\n    },\n    teardown: async () => {\n      if (globalScope) {\n        globalScope.removeEventListener('popstate', saveUrlInfoWrapper);\n\n        isTracking = false;\n      }\n\n      if (sessionStorage && isStorageEnabled) {\n        await sessionStorage.set(URL_INFO_STORAGE_KEY, {});\n      }\n    },\n  };\n\n  return plugin;\n};\n\nfunction addIfNotExist(event: Event, key: string, value: string): string {\n  if (!event.event_properties) {\n    event.event_properties = {};\n  }\n\n  if ((event.event_properties as { [key: string]: any })[key] === undefined) {\n    return value;\n  }\n\n  return (event.event_properties as { [key: string]: any })[key] as string;\n}\n"]}