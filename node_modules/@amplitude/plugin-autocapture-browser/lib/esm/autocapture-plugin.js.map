{"version":3,"file":"autocapture-plugin.js","sourceRoot":"","sources":["../../src/autocapture-plugin.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable no-restricted-globals */\nimport {\n  type BrowserClient,\n  type BrowserConfig,\n  type EnrichmentPlugin,\n  type ElementInteractionsOptions,\n  DEFAULT_CSS_SELECTOR_ALLOWLIST,\n  DEFAULT_ACTION_CLICK_ALLOWLIST,\n  DEFAULT_DATA_ATTRIBUTE_PREFIX,\n  IDiagnosticsClient,\n  getGlobalScope,\n  multicast,\n} from '@amplitude/analytics-core';\nimport { VERSION } from './version';\nimport * as constants from './constants';\nimport {\n  createShouldTrackEvent,\n  type ElementBasedTimestampedEvent,\n  type TimestampedEvent,\n  type NavigateEvent,\n} from './helpers';\nimport { WindowMessenger } from './libs/messenger';\nimport { trackClicks } from './autocapture/track-click';\nimport { trackChange } from './autocapture/track-change';\nimport { trackActionClick } from './autocapture/track-action-click';\nimport { createClickObservable, createMutationObservable } from './observables';\n\nimport {\n  createLabeledEventToTriggerMap,\n  createTriggerEvaluator,\n  groupLabeledEventIdsByEventType,\n} from './pageActions/triggers';\nimport { DataExtractor } from './data-extractor';\nimport { Observable, Unsubscribable } from '@amplitude/analytics-core';\n\ntype NavigationType = {\n  addEventListener: (type: string, listener: EventListenerOrEventListenerObject) => void;\n  removeEventListener: (type: string, listener: EventListenerOrEventListenerObject) => void;\n};\n\ndeclare global {\n  interface Window {\n    navigation: NavigationType;\n  }\n}\n\ntype BrowserEnrichmentPlugin = EnrichmentPlugin<BrowserClient, BrowserConfig>;\n\nexport type AutoCaptureOptionsWithDefaults = Required<\n  Pick<ElementInteractionsOptions, 'debounceTime' | 'cssSelectorAllowlist' | 'actionClickAllowlist'>\n> &\n  ElementInteractionsOptions;\n\nexport enum ObservablesEnum {\n  ClickObservable = 'clickObservable',\n  ChangeObservable = 'changeObservable',\n  // ErrorObservable = 'errorObservable',\n  NavigateObservable = 'navigateObservable',\n  MutationObservable = 'mutationObservable',\n}\n\nexport interface AllWindowObservables {\n  [ObservablesEnum.ChangeObservable]: Observable<ElementBasedTimestampedEvent<Event>>;\n  // [ObservablesEnum.ErrorObservable]: Observable<TimestampedEvent<ErrorEvent>>;\n  [ObservablesEnum.ClickObservable]: Observable<ElementBasedTimestampedEvent<MouseEvent>>;\n  [ObservablesEnum.MutationObservable]: Observable<TimestampedEvent<MutationRecord[]>>;\n  [ObservablesEnum.NavigateObservable]?: Observable<TimestampedEvent<NavigateEvent>>;\n}\n\nexport const autocapturePlugin = (\n  options: ElementInteractionsOptions = {},\n  context?: { diagnosticsClient: IDiagnosticsClient },\n): BrowserEnrichmentPlugin => {\n  // Set the plugin version tag\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n  context?.diagnosticsClient.setTag('plugin.autocapture.version', VERSION);\n\n  const {\n    dataAttributePrefix = DEFAULT_DATA_ATTRIBUTE_PREFIX,\n    visualTaggingOptions = {\n      enabled: true,\n      messenger: new WindowMessenger(),\n    },\n  } = options;\n\n  options.cssSelectorAllowlist = options.cssSelectorAllowlist ?? DEFAULT_CSS_SELECTOR_ALLOWLIST;\n  options.actionClickAllowlist = options.actionClickAllowlist ?? DEFAULT_ACTION_CLICK_ALLOWLIST;\n  options.debounceTime = options.debounceTime ?? 0;\n\n  options.pageUrlExcludelist = options.pageUrlExcludelist?.reduce(\n    (acc: (string | RegExp | { pattern: string })[], excludePattern) => {\n      if (typeof excludePattern === 'string') {\n        acc.push(excludePattern);\n      }\n      if (excludePattern instanceof RegExp) {\n        acc.push(excludePattern);\n      }\n      if (typeof excludePattern === 'object' && excludePattern !== null && 'pattern' in excludePattern) {\n        try {\n          acc.push(new RegExp(excludePattern.pattern));\n        } catch (regexError) {\n          console.warn(`Invalid regex pattern: ${excludePattern.pattern}`, regexError);\n          return acc;\n        }\n      }\n      return acc;\n    },\n    [],\n  );\n\n  const name = constants.PLUGIN_NAME;\n  const type = 'enrichment';\n\n  const subscriptions: Unsubscribable[] = [];\n\n  // Create data extractor based on options\n  const dataExtractor = new DataExtractor(options, context);\n\n  // Create observables on events on the window\n  const createObservables = (): AllWindowObservables => {\n    const clickObservable = multicast(\n      createClickObservable().map(\n        (click) =>\n          dataExtractor.addAdditionalEventProperties(\n            click,\n            'click',\n            (options as AutoCaptureOptionsWithDefaults).cssSelectorAllowlist,\n            dataAttributePrefix,\n          ) as ElementBasedTimestampedEvent<MouseEvent>,\n      ),\n    );\n\n    const changeObservable = multicast(\n      new Observable<ElementBasedTimestampedEvent<Event>>((observer) => {\n        const handler = (changeEvent: Event) => {\n          const enrichedChangeEvent = dataExtractor.addAdditionalEventProperties(\n            changeEvent,\n            'change',\n            (options as AutoCaptureOptionsWithDefaults).cssSelectorAllowlist,\n            dataAttributePrefix,\n          ) as ElementBasedTimestampedEvent<Event>;\n          observer.next(enrichedChangeEvent);\n        };\n        /* istanbul ignore next */\n        getGlobalScope()?.document.addEventListener('change', handler, { capture: true });\n        /* istanbul ignore next */\n        return () => getGlobalScope()?.document.removeEventListener('change', handler);\n      }),\n    );\n\n    // Create Observable from unhandled errors\n    // const errorObservable = fromEvent<ErrorEvent>(window, 'error').pipe(\n    //   map((error) => addAdditionalEventProperties(error, 'error')),\n    // );\n\n    // Create observable for URL changes\n    let navigateObservable: Observable<TimestampedEvent<NavigateEvent>> | undefined;\n\n    /* istanbul ignore next */\n    if (window.navigation) {\n      navigateObservable = multicast(\n        new Observable<TimestampedEvent<NavigateEvent>>((observer) => {\n          const handler = (navigateEvent: NavigateEvent) => {\n            const enrichedNavigateEvent = dataExtractor.addAdditionalEventProperties(\n              navigateEvent,\n              'navigate',\n              (options as AutoCaptureOptionsWithDefaults).cssSelectorAllowlist,\n              dataAttributePrefix,\n            );\n            observer.next(enrichedNavigateEvent);\n          };\n          window.navigation.addEventListener('navigate', handler as EventListener);\n          return () => {\n            window.navigation.removeEventListener('navigate', handler as EventListener);\n          };\n        }),\n      );\n    }\n\n    const mutationObservable = multicast(\n      createMutationObservable().map((mutation) =>\n        dataExtractor.addAdditionalEventProperties(\n          mutation,\n          'mutation',\n          (options as AutoCaptureOptionsWithDefaults).cssSelectorAllowlist,\n          dataAttributePrefix,\n        ),\n      ),\n    );\n\n    return {\n      [ObservablesEnum.ChangeObservable]: changeObservable,\n      // [ObservablesEnum.ErrorObservable]: errorObservable,\n      [ObservablesEnum.ClickObservable]: clickObservable,\n      [ObservablesEnum.MutationObservable]: mutationObservable,\n      [ObservablesEnum.NavigateObservable]: navigateObservable,\n    };\n  };\n\n  // Group labeled events by event type (eg. click, change)\n  let groupedLabeledEvents = groupLabeledEventIdsByEventType(Object.values(options.pageActions?.labeledEvents ?? {}));\n\n  let labeledEventToTriggerMap = createLabeledEventToTriggerMap(options.pageActions?.triggers ?? []);\n\n  // Evaluate triggers for the given event by running the actions associated with the matching triggers\n  const evaluateTriggers = createTriggerEvaluator(\n    groupedLabeledEvents,\n    labeledEventToTriggerMap,\n    dataExtractor,\n    options,\n  );\n\n  // Function to recalculate internal variables when remote config is updated\n  const recomputePageActionsData = (remotePageActions: ElementInteractionsOptions['pageActions']) => {\n    if (remotePageActions) {\n      // Merge remote config with local options\n      options.pageActions = {\n        ...options.pageActions,\n        ...remotePageActions,\n      };\n\n      // Recalculate internal variables\n      groupedLabeledEvents = groupLabeledEventIdsByEventType(Object.values(options.pageActions.labeledEvents ?? {}));\n      labeledEventToTriggerMap = createLabeledEventToTriggerMap(options.pageActions.triggers ?? []);\n\n      // Update evaluateTriggers function\n      evaluateTriggers.update(groupedLabeledEvents, labeledEventToTriggerMap, options);\n    }\n  };\n\n  const setup: BrowserEnrichmentPlugin['setup'] = async (config, amplitude) => {\n    /* istanbul ignore if */\n    if (typeof document === 'undefined') {\n      return;\n    }\n\n    // Fetch remote config for pageActions in a non-blocking manner\n    if (config.fetchRemoteConfig) {\n      if (!config.remoteConfigClient) {\n        // TODO(xinyi): Diagnostics.recordEvent\n        config.loggerProvider.debug('Remote config client is not provided, skipping remote config fetch');\n      } else {\n        config.remoteConfigClient.subscribe('analyticsSDK.pageActions', 'all', (remoteConfig) => {\n          recomputePageActionsData(remoteConfig as ElementInteractionsOptions['pageActions']);\n        });\n      }\n    }\n\n    // Create should track event functions the different allowlists\n    const shouldTrackEvent = createShouldTrackEvent(\n      options,\n      (options as AutoCaptureOptionsWithDefaults).cssSelectorAllowlist,\n    );\n    const shouldTrackActionClick = createShouldTrackEvent(\n      options,\n      (options as AutoCaptureOptionsWithDefaults).actionClickAllowlist,\n    );\n\n    // Create observables for events on the window\n    const allObservables = createObservables();\n\n    // Create subscriptions\n    const clickTrackingSubscription = trackClicks({\n      allObservables,\n      amplitude,\n      shouldTrackEvent: shouldTrackEvent,\n      evaluateTriggers: evaluateTriggers.evaluate.bind(evaluateTriggers),\n    });\n\n    subscriptions.push(clickTrackingSubscription);\n\n    const changeSubscription = trackChange({\n      allObservables,\n      getEventProperties: (...args) => dataExtractor.getEventProperties(...args, dataAttributePrefix),\n      amplitude,\n      shouldTrackEvent: shouldTrackEvent,\n      evaluateTriggers: evaluateTriggers.evaluate.bind(evaluateTriggers),\n    });\n    subscriptions.push(changeSubscription);\n\n    const actionClickSubscription = trackActionClick({\n      allObservables,\n      options: options as AutoCaptureOptionsWithDefaults,\n      getEventProperties: (...args) => dataExtractor.getEventProperties(...args, dataAttributePrefix),\n      amplitude,\n      shouldTrackEvent,\n      shouldTrackActionClick: shouldTrackActionClick,\n    });\n    if (actionClickSubscription) {\n      subscriptions.push(actionClickSubscription);\n    }\n\n    /* istanbul ignore next */\n    config?.loggerProvider?.log(`${name} has been successfully added.`);\n\n    // Setup visual tagging selector\n    if (window.opener && visualTaggingOptions.enabled) {\n      const allowlist = (options as AutoCaptureOptionsWithDefaults).cssSelectorAllowlist;\n      const actionClickAllowlist = (options as AutoCaptureOptionsWithDefaults).actionClickAllowlist;\n\n      /* istanbul ignore next */\n      visualTaggingOptions.messenger?.setup({\n        dataExtractor: dataExtractor,\n        logger: config?.loggerProvider,\n        ...(config?.serverZone && { endpoint: constants.AMPLITUDE_ORIGINS_MAP[config.serverZone] }),\n        isElementSelectable: createShouldTrackEvent(options, [...allowlist, ...actionClickAllowlist]),\n        cssSelectorAllowlist: allowlist,\n        actionClickAllowlist: actionClickAllowlist,\n      });\n    }\n  };\n\n  const execute: BrowserEnrichmentPlugin['execute'] = async (event) => {\n    return event;\n  };\n\n  const teardown = async () => {\n    for (const subscription of subscriptions) {\n      subscription.unsubscribe();\n    }\n  };\n\n  return {\n    name,\n    type,\n    setup,\n    execute,\n    teardown,\n  };\n};\n"]}