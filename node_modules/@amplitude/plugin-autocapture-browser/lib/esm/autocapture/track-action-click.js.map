{"version":3,"file":"track-action-click.js","sourceRoot":"","sources":["../../../src/autocapture/track-action-click.ts"],"names":[],"mappings":"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","sourcesContent":["import { AllWindowObservables, AutoCaptureOptionsWithDefaults } from 'src/autocapture-plugin';\nimport { BrowserClient, ActionType, merge, asyncMap } from '@amplitude/analytics-core';\nimport {\n  ElementBasedTimestampedEvent,\n  filterOutNonTrackableEvents,\n  getClosestElement,\n  shouldTrackEvent,\n  TimestampedEvent,\n} from '../helpers';\nimport { AMPLITUDE_ELEMENT_CLICKED_EVENT } from '../constants';\n\nexport function trackActionClick({\n  amplitude,\n  allObservables,\n  options,\n  getEventProperties,\n  shouldTrackEvent,\n  shouldTrackActionClick,\n}: {\n  amplitude: BrowserClient;\n  allObservables: AllWindowObservables;\n  options: AutoCaptureOptionsWithDefaults;\n  getEventProperties: (actionType: ActionType, element: Element) => Record<string, any>;\n  shouldTrackActionClick: shouldTrackEvent;\n  shouldTrackEvent: shouldTrackEvent;\n}) {\n  const { clickObservable, mutationObservable, navigateObservable } = allObservables;\n\n  const filteredClickObservable = clickObservable\n    .filter((click) => {\n      return !shouldTrackEvent('click', click.closestTrackedAncestor);\n    })\n    .map((click) => {\n      // overwrite the closestTrackedAncestor with the closest element that is on the actionClickAllowlist\n      const closestActionClickEl = getClosestElement(click.event.target as Element, options.actionClickAllowlist);\n      click.closestTrackedAncestor = closestActionClickEl as Element;\n\n      // overwrite the targetElementProperties with the properties of the closestActionClickEl\n      if (click.closestTrackedAncestor !== null) {\n        click.targetElementProperties = getEventProperties(click.type, click.closestTrackedAncestor);\n      }\n      return click;\n    })\n    .filter(filterOutNonTrackableEvents)\n    .filter((clickEvent) => {\n      // Only track change on elements that should be tracked\n      return shouldTrackActionClick('click', clickEvent.closestTrackedAncestor);\n    });\n\n  const mutationOrNavigate = navigateObservable ? merge(mutationObservable, navigateObservable) : mutationObservable;\n\n  const clickMutationNavigateObservable = merge(filteredClickObservable, mutationOrNavigate);\n\n  let actionClickTimer: ReturnType<typeof setTimeout> | null = null;\n  let lastClickEvent: TimestampedEvent<any> | null = null;\n\n  const actionClickObservable = asyncMap(clickMutationNavigateObservable, (event) => {\n    // clear any previous timer\n    if (actionClickTimer) {\n      clearTimeout(actionClickTimer);\n      actionClickTimer = null;\n    }\n    if (event.type === 'click') {\n      // mark the 'last click event'\n      lastClickEvent = event;\n\n      // set a timer to clear last click event if no mutation event between now and 500ms\n      actionClickTimer = setTimeout(() => {\n        actionClickTimer = null;\n        lastClickEvent = null;\n      }, 500);\n      return Promise.resolve(null);\n    } else {\n      // if mutation/navigation + last click event, then it's an action click\n      if (lastClickEvent) {\n        const event = lastClickEvent;\n        lastClickEvent = null;\n        return Promise.resolve(event);\n      }\n    }\n    return Promise.resolve(null);\n  });\n\n  return actionClickObservable.subscribe((actionClick) => {\n    if (!actionClick) return;\n    /* istanbul ignore next */\n    amplitude?.track(\n      AMPLITUDE_ELEMENT_CLICKED_EVENT,\n      getEventProperties('click', (actionClick as ElementBasedTimestampedEvent<MouseEvent>).closestTrackedAncestor),\n    );\n  });\n}\n"]}