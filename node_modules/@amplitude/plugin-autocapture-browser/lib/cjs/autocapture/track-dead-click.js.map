{"version":3,"file":"track-dead-click.js","sourceRoot":"","sources":["../../../src/autocapture/track-dead-click.ts"],"names":[],"mappings":";;;;AACA,4DAAuF;AACvF,sCAAyG;AACzG,0CAAoE;AACpE,IAAM,kBAAkB,GAAG,IAAI,CAAC,CAAC,8CAA8C;AAO/E,IAAM,aAAa,GAAG,CAAC,UAAU,EAAE,UAAU,CAAC,CAAC;AAE/C,SAAgB,cAAc,CAAC,EAU9B;QATC,SAAS,eAAA,EACT,cAAc,oBAAA,EACd,kBAAkB,wBAAA,EAClB,oBAAoB,0BAAA;IAOZ,IAAA,eAAe,GAAmE,cAAc,gBAAjF,EAAE,kBAAkB,GAA+C,cAAc,mBAA7D,EAAE,kBAAkB,GAA2B,cAAc,mBAAzC,CAA0C;IAEzG,IAAM,uBAAuB,GAAG,eAAe,CAAC,MAAM,CAAC,UAAC,KAAK;QAC3D,OAAO,CACL,IAAA,qCAA2B,EAAC,KAAK,CAAC;YAClC,oBAAoB,CAAC,OAAO,EAAE,KAAK,CAAC,sBAAsB,CAAC;YAC3D,KAAK,CAAC,KAAK,CAAC,MAAM,YAAY,OAAO;YACrC,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,oBAAoB,CAAC,KAAK,IAAI,CAC1D,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,0BAA0B;IAC1B,IAAM,iBAAiB,GAAG,kBAAkB,CAAC,CAAC,CAAC,IAAA,sBAAK,EAAC,kBAAkB,EAAE,kBAAkB,CAAC,CAAC,CAAC,CAAC,kBAAkB,CAAC;IAElH,IAAM,yBAAyB,GAAG,IAAA,sBAAK,EAAC,uBAAuB,EAAE,iBAAiB,CAAC,CAAC;IAEpF,IAAI,cAAc,GAAyC,IAAI,CAAC;IAEhE,IAAM,mBAAmB,GAAG,IAAA,yBAAQ,EAClC,yBAAyB,EACzB,UAAC,KAAK;QACJ,IAAI,cAAc,IAAI,aAAa,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;YACxD,2EAA2E;YAC3E,YAAY,CAAC,cAAc,CAAC,CAAC;YAC7B,cAAc,GAAG,IAAI,CAAC;YACtB,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;SAC9B;aAAM,IAAI,KAAK,CAAC,IAAI,KAAK,OAAO,EAAE;YACjC,mDAAmD;YACnD,yEAAyE;YACzE,8CAA8C;YAC9C,IAAI,cAAc,EAAE;gBAClB,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;aAC9B;YACD,OAAO,IAAI,OAAO,CAAC,UAAC,OAAO;gBACzB,cAAc,GAAG,UAAU,CAAC;oBAC1B,OAAO,CAAC,KAAiD,CAAC,CAAC;oBAC3D,cAAc,GAAG,IAAI,CAAC;gBACxB,CAAC,EAAE,kBAAkB,CAAC,CAAC;YACzB,CAAC,CAAC,CAAC;SACJ;QACD,2DAA2D;QAC3D,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IAC/B,CAAC,CACF,CAAC;IAEF,OAAO,mBAAmB,CAAC,SAAS,CAAC,UAAC,WAAW;QAC/C,IAAI,CAAC,WAAW;YAAE,OAAO;QACzB,IAAM,cAAc,GAAmB;YACrC,eAAe,EAAG,WAAW,CAAC,KAAoB,CAAC,OAAO;YAC1D,eAAe,EAAG,WAAW,CAAC,KAAoB,CAAC,OAAO;SAC3D,CAAC;QACF,SAAS,CAAC,KAAK,CACb,gDAAoC,wCAE/B,kBAAkB,CAAC,OAAO,EAAE,WAAW,CAAC,sBAAsB,CAAC,GAC/D,cAAc,GAEnB,EAAE,IAAI,EAAE,WAAW,CAAC,SAAS,EAAE,CAChC,CAAC;IACJ,CAAC,CAAC,CAAC;AACL,CAAC;AAvED,wCAuEC","sourcesContent":["import { AllWindowObservables } from 'src/frustration-plugin';\nimport { BrowserClient, ActionType, merge, asyncMap } from '@amplitude/analytics-core';\nimport { ElementBasedTimestampedEvent, filterOutNonTrackableEvents, shouldTrackEvent } from '../helpers';\nimport { AMPLITUDE_ELEMENT_DEAD_CLICKED_EVENT } from '../constants';\nconst DEAD_CLICK_TIMEOUT = 3000; // 3 seconds to wait for an activity to happen\n\ntype EventDeadClick = {\n  '[Amplitude] X': number;\n  '[Amplitude] Y': number;\n};\n\nconst CHANGE_EVENTS = ['mutation', 'navigate'];\n\nexport function trackDeadClick({\n  amplitude,\n  allObservables,\n  getEventProperties,\n  shouldTrackDeadClick,\n}: {\n  amplitude: BrowserClient;\n  allObservables: AllWindowObservables;\n  getEventProperties: (actionType: ActionType, element: Element) => Record<string, any>;\n  shouldTrackDeadClick: shouldTrackEvent;\n}) {\n  const { clickObservable, mutationObservable, navigateObservable }: AllWindowObservables = allObservables;\n\n  const filteredClickObservable = clickObservable.filter((click) => {\n    return (\n      filterOutNonTrackableEvents(click) &&\n      shouldTrackDeadClick('click', click.closestTrackedAncestor) &&\n      click.event.target instanceof Element &&\n      click.event.target.closest('a[target=\"_blank\"]') === null\n    );\n  });\n\n  /* istanbul ignore next */\n  const changeObservables = navigateObservable ? merge(mutationObservable, navigateObservable) : mutationObservable;\n\n  const clicksAndChangeObservable = merge(filteredClickObservable, changeObservables);\n\n  let deadClickTimer: ReturnType<typeof setTimeout> | null = null;\n\n  const deadClickObservable = asyncMap(\n    clicksAndChangeObservable,\n    (event): Promise<ElementBasedTimestampedEvent<MouseEvent> | null> => {\n      if (deadClickTimer && CHANGE_EVENTS.includes(event.type)) {\n        // a mutation or navigation means it's not a dead click, so clear the timer\n        clearTimeout(deadClickTimer);\n        deadClickTimer = null;\n        return Promise.resolve(null);\n      } else if (event.type === 'click') {\n        // if a dead click is already on-deck, return null.\n        // this throttles dead clicks events so no more than one dead click event\n        // is tracked per every DEAD_CLICK_TIMEOUT ms.\n        if (deadClickTimer) {\n          return Promise.resolve(null);\n        }\n        return new Promise((resolve) => {\n          deadClickTimer = setTimeout(() => {\n            resolve(event as ElementBasedTimestampedEvent<MouseEvent>);\n            deadClickTimer = null;\n          }, DEAD_CLICK_TIMEOUT);\n        });\n      }\n      // unreachable code, but needed to satisfy the type checker\n      return Promise.resolve(null);\n    },\n  );\n\n  return deadClickObservable.subscribe((actionClick) => {\n    if (!actionClick) return;\n    const deadClickEvent: EventDeadClick = {\n      '[Amplitude] X': (actionClick.event as MouseEvent).clientX,\n      '[Amplitude] Y': (actionClick.event as MouseEvent).clientY,\n    };\n    amplitude.track(\n      AMPLITUDE_ELEMENT_DEAD_CLICKED_EVENT,\n      {\n        ...getEventProperties('click', actionClick.closestTrackedAncestor),\n        ...deadClickEvent,\n      },\n      { time: actionClick.timestamp },\n    );\n  });\n}\n"]}