{"version":3,"file":"track-rage-click.js","sourceRoot":"","sources":["../../../src/autocapture/track-rage-click.ts"],"names":[],"mappings":"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","sourcesContent":["import { AllWindowObservables } from 'src/frustration-plugin';\nimport {\n  BrowserClient,\n  asyncMap,\n  DEFAULT_RAGE_CLICK_THRESHOLD,\n  DEFAULT_RAGE_CLICK_WINDOW_MS,\n  DEFAULT_RAGE_CLICK_OUT_OF_BOUNDS_THRESHOLD,\n} from '@amplitude/analytics-core';\nimport { shouldTrackEvent } from '../helpers';\nimport { AMPLITUDE_ELEMENT_RAGE_CLICKED_EVENT } from '../constants';\n\nconst RAGE_CLICK_THRESHOLD = DEFAULT_RAGE_CLICK_THRESHOLD;\nconst RAGE_CLICK_WINDOW_MS = DEFAULT_RAGE_CLICK_WINDOW_MS;\nconst RAGE_CLICK_OUT_OF_BOUNDS_THRESHOLD = DEFAULT_RAGE_CLICK_OUT_OF_BOUNDS_THRESHOLD;\n\ntype Click = {\n  X: number;\n  Y: number;\n  Time: number;\n};\n\ntype EventRageClick = {\n  '[Amplitude] Begin Time': string; // ISO-8601\n  '[Amplitude] End Time': string; // ISO-8601\n  '[Amplitude] Duration': number;\n  '[Amplitude] Clicks': Array<Click>;\n  '[Amplitude] Click Count': number;\n};\n\ntype ClickEvent = {\n  event: MouseEvent | Event;\n  timestamp: number;\n  targetElementProperties: Record<string, any>;\n  closestTrackedAncestor: Element | null;\n};\n\ntype ClickRegionBoundingBox = {\n  yMin?: number;\n  yMax?: number;\n  xMin?: number;\n  xMax?: number;\n  isOutOfBounds?: boolean;\n};\n\ntype RageClickEvent = {\n  rageClickEvent: EventRageClick;\n  time: number;\n};\n\nfunction addCoordinates(regionBox: ClickRegionBoundingBox, click: ClickEvent) {\n  const { clientX, clientY } = click.event as MouseEvent;\n  regionBox.yMin = Math.min(regionBox.yMin ?? clientY, clientY);\n  regionBox.yMax = Math.max(regionBox.yMax ?? clientY, clientY);\n  regionBox.xMin = Math.min(regionBox.xMin ?? clientX, clientX);\n  regionBox.xMax = Math.max(regionBox.xMax ?? clientX, clientX);\n  regionBox.isOutOfBounds =\n    regionBox.yMax - regionBox.yMin > RAGE_CLICK_OUT_OF_BOUNDS_THRESHOLD ||\n    regionBox.xMax - regionBox.xMin > RAGE_CLICK_OUT_OF_BOUNDS_THRESHOLD;\n}\n\nfunction getRageClickAnalyticsEvent(clickWindow: ClickEvent[]) {\n  /* istanbul ignore if */\n  if (clickWindow.length === 0) {\n    return null;\n  }\n  const firstClick = clickWindow[0];\n  const lastClick = clickWindow[clickWindow.length - 1];\n\n  const rageClickEvent: EventRageClick = {\n    '[Amplitude] Begin Time': new Date(firstClick.timestamp).toISOString(),\n    '[Amplitude] End Time': new Date(lastClick.timestamp).toISOString(),\n    '[Amplitude] Duration': lastClick.timestamp - firstClick.timestamp,\n    '[Amplitude] Clicks': clickWindow.map((click) => ({\n      X: (click.event as MouseEvent).clientX,\n      Y: (click.event as MouseEvent).clientY,\n      Time: click.timestamp,\n    })),\n    '[Amplitude] Click Count': clickWindow.length,\n    ...firstClick.targetElementProperties,\n  };\n\n  return { rageClickEvent, time: firstClick.timestamp };\n}\n\nfunction isClickOutsideRageClickWindow(clickWindow: ClickEvent[], click: ClickEvent) {\n  const firstIndex = Math.max(0, clickWindow.length - RAGE_CLICK_THRESHOLD + 1);\n  const firstClick = clickWindow[firstIndex];\n  return click.timestamp - firstClick.timestamp >= RAGE_CLICK_WINDOW_MS;\n}\n\nfunction isNewElement(clickWindow: ClickEvent[], click: ClickEvent) {\n  return (\n    clickWindow.length > 0 &&\n    clickWindow[clickWindow.length - 1].closestTrackedAncestor !== click.closestTrackedAncestor\n  );\n}\n\nexport function trackRageClicks({\n  amplitude,\n  allObservables,\n  shouldTrackRageClick,\n}: {\n  amplitude: BrowserClient;\n  allObservables: AllWindowObservables;\n  shouldTrackRageClick: shouldTrackEvent;\n}) {\n  const { clickObservable }: AllWindowObservables = allObservables;\n\n  // Keep track of all clicks within the sliding window\n  let clickWindow: ClickEvent[] = [];\n\n  // Keep track of the region box for all clicks, to determine when a rage click is out of bounds\n  let clickBoundingBox: ClickRegionBoundingBox = {};\n\n  let pendingRageClick: {\n    resolve: (rageClickEvent: RageClickEvent | null) => void;\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    timerId: any;\n  } | null = null;\n\n  // helper function to reset the click window and region box\n  function resetClickWindow(click?: ClickEvent) {\n    clickWindow = [];\n    clickBoundingBox = {};\n    if (click) {\n      addCoordinates(clickBoundingBox, click);\n      clickWindow.push(click);\n    }\n  }\n\n  const rageClickObservable = asyncMap(\n    clickObservable.filter((click) => shouldTrackRageClick('click', click.closestTrackedAncestor)),\n    async (click: ClickEvent): Promise<RageClickEvent | null> => {\n      // add this click's coordinates to the bounding box\n      addCoordinates(clickBoundingBox, click);\n\n      let resolutionValue: RageClickEvent | null = null;\n\n      // if current click is:\n      //  1. first click in the window\n      //  2. on a new element\n      //  3. outside the rage click time window\n      //  4. out of bounds\n      // then start a new click window\n      if (\n        clickWindow.length === 0 ||\n        isNewElement(clickWindow, click) ||\n        isClickOutsideRageClickWindow(clickWindow, click) ||\n        clickBoundingBox.isOutOfBounds\n      ) {\n        // if there was a previous Rage Click Event on deck, then send it\n        if (pendingRageClick) {\n          resolutionValue = getRageClickAnalyticsEvent(clickWindow);\n        }\n\n        resetClickWindow(click);\n      } else {\n        clickWindow.push(click);\n      }\n\n      // if there was a previous Rage Click Event on deck, then resolve it\n      if (pendingRageClick) {\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n        clearTimeout(pendingRageClick.timerId);\n        pendingRageClick.resolve(resolutionValue);\n        pendingRageClick = null;\n      }\n\n      // if we have enough clicks to be a rage click, set a timout to trigger the rage\n      // click event after the time threshold is reached.\n      // This will be cancelled if a new click is tracked within the time threshold.\n      if (clickWindow.length >= RAGE_CLICK_THRESHOLD) {\n        return new Promise((resolve) => {\n          pendingRageClick = {\n            resolve,\n            timerId: setTimeout(() => {\n              resolve(getRageClickAnalyticsEvent(clickWindow));\n            }, RAGE_CLICK_WINDOW_MS),\n          };\n        });\n      }\n\n      return null;\n    },\n  );\n\n  return rageClickObservable.subscribe((data: RageClickEvent | null) => {\n    /* istanbul ignore if */\n    if (data === null) {\n      return;\n    }\n    amplitude.track(AMPLITUDE_ELEMENT_RAGE_CLICKED_EVENT, data.rageClickEvent, { time: data.time });\n  });\n}\n"]}