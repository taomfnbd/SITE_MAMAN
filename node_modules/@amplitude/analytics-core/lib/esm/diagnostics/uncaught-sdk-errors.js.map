{"version":3,"file":"uncaught-sdk-errors.js","sourceRoot":"","sources":["../../../src/diagnostics/uncaught-sdk-errors.ts"],"names":[],"mappings":"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","sourcesContent":["import { getGlobalScope } from '../global-scope';\nimport { IDiagnosticsClient } from './diagnostics-client';\n\ntype ErrorEventType = 'error' | 'unhandledrejection';\n\ninterface CapturedErrorContext {\n  readonly type: ErrorEventType;\n  readonly message: string;\n  readonly stack?: string;\n  readonly filename?: string;\n  readonly errorName?: string;\n  readonly metadata?: Record<string, unknown>;\n}\n\nexport const GLOBAL_KEY = '__AMPLITUDE_SCRIPT_URL__';\nexport const EVENT_NAME_ERROR_UNCAUGHT = 'sdk.error.uncaught';\n\nconst getNormalizedScriptUrl = (): string | undefined => {\n  const scope = getGlobalScope() as Record<string, unknown> | null;\n  /* istanbul ignore next */\n  return scope?.[GLOBAL_KEY] as string | undefined;\n};\n\nconst setNormalizedScriptUrl = (url: string) => {\n  const scope = getGlobalScope() as Record<string, unknown> | null;\n  if (scope) {\n    scope[GLOBAL_KEY] = url;\n  }\n};\n\nexport const registerSdkLoaderMetadata = (metadata: { scriptUrl?: string }) => {\n  if (metadata.scriptUrl) {\n    const normalized = normalizeUrl(metadata.scriptUrl);\n    if (normalized) {\n      setNormalizedScriptUrl(normalized);\n    }\n  }\n};\n\nexport const enableSdkErrorListeners = (client: IDiagnosticsClient) => {\n  const scope = getGlobalScope();\n\n  if (!scope || typeof scope.addEventListener !== 'function') {\n    return;\n  }\n\n  const handleError = (event: ErrorEvent) => {\n    const error = event.error instanceof Error ? event.error : undefined;\n    const stack = error?.stack;\n    const match = detectSdkOrigin({ filename: event.filename, stack });\n    if (!match) {\n      return;\n    }\n\n    capture({\n      type: 'error',\n      message: event.message,\n      stack,\n      filename: event.filename,\n      errorName: error?.name,\n      metadata: {\n        colno: event.colno,\n        lineno: event.lineno,\n        isTrusted: event.isTrusted,\n        matchReason: match,\n      },\n    });\n  };\n\n  const handleRejection = (event: PromiseRejectionEvent) => {\n    const error = event.reason instanceof Error ? event.reason : undefined;\n    const stack = error?.stack;\n    const filename = extractFilenameFromStack(stack);\n    const match = detectSdkOrigin({ filename, stack });\n\n    if (!match) {\n      return;\n    }\n\n    /* istanbul ignore next */\n    capture({\n      type: 'unhandledrejection',\n      message: error?.message ?? stringifyReason(event.reason),\n      stack,\n      filename,\n      errorName: error?.name,\n      metadata: {\n        isTrusted: event.isTrusted,\n        matchReason: match,\n      },\n    });\n  };\n\n  const capture = (context: CapturedErrorContext) => {\n    client.recordEvent(EVENT_NAME_ERROR_UNCAUGHT, {\n      type: context.type,\n      message: context.message,\n      filename: context.filename,\n      error_name: context.errorName,\n      stack: context.stack,\n      ...context.metadata,\n    });\n  };\n\n  scope.addEventListener('error', handleError, true);\n  scope.addEventListener('unhandledrejection', handleRejection, true);\n};\n\nconst detectSdkOrigin = (payload: { filename?: string; stack?: string }): 'filename' | 'stack' | undefined => {\n  const normalizedScriptUrl = getNormalizedScriptUrl();\n  if (!normalizedScriptUrl) {\n    return undefined;\n  }\n\n  if (payload.filename && payload.filename.includes(normalizedScriptUrl)) {\n    return 'filename';\n  }\n\n  if (payload.stack && payload.stack.includes(normalizedScriptUrl)) {\n    return 'stack';\n  }\n\n  return undefined;\n};\n\nconst normalizeUrl = (value: string) => {\n  try {\n    /* istanbul ignore next */\n    const url = new URL(value, getGlobalScope()?.location?.origin);\n    return url.origin + url.pathname;\n  } catch {\n    return undefined;\n  }\n};\n\nconst extractFilenameFromStack = (stack?: string) => {\n  if (!stack) {\n    return undefined;\n  }\n\n  const match = stack.match(/(https?:\\/\\/\\S+?)(?=[)\\s]|$)/);\n  /* istanbul ignore next */\n  return match ? match[1] : undefined;\n};\n\n/* istanbul ignore next */\nconst stringifyReason = (reason: unknown) => {\n  if (typeof reason === 'string') {\n    return reason;\n  }\n\n  try {\n    return JSON.stringify(reason);\n  } catch {\n    return '[object Object]';\n  }\n};\n"]}